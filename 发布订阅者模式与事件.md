### è§‚å¯Ÿè€…è€…æ¨¡å¼

å¾ˆæ—©ä»¥å‰å†™äº†ä¸€ç¯‡å…³äºè§‚å¯Ÿè€…æ¨¡å¼(å‘å¸ƒè®¢é˜…æ¨¡å¼)çš„ç®€å•å®ç°, ç°åœ¨æœ‰äº†æ–°çš„æ„Ÿæ‚Ÿ, æ¡èµ·æ¥å†å•ƒå•ƒ.

å…ˆä¸Šç»´åŸºç™¾ç§‘çœ‹çœ‹: 

> è§‚å¯Ÿè€…æ¨¡å¼æ˜¯è½¯ä»¶è®¾è®¡æ¨¡å¼çš„ä¸€ç§ã€‚åœ¨æ­¤ç§æ¨¡å¼ä¸­ï¼Œä¸€ä¸ªç›®æ ‡å¯¹è±¡ç®¡ç†æ‰€æœ‰ç›¸ä¾äºå®ƒçš„è§‚å¯Ÿè€…å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨å®ƒæœ¬èº«çš„çŠ¶æ€æ”¹å˜æ—¶ä¸»åŠ¨å‘å‡ºé€šçŸ¥ã€‚è¿™é€šå¸¸é€è¿‡å‘¼å«å„è§‚å¯Ÿè€…æ‰€æä¾›çš„æ–¹æ³•æ¥å®ç°ã€‚æ­¤ç§æ¨¡å¼é€šå¸¸è¢«ç”¨æ¥å®æ—¶äº‹ä»¶å¤„ç†ç³»ç»Ÿã€‚



ç†è§£èµ·æ¥å¾ˆç®€å•: æˆ‘å»ä¹¦æŠ¥äº­è®¢äº†ä¸€ä»½æŠ¥çº¸,å½“ä»–æŠŠæŠ¥çº¸é€ç»™æˆ‘äº†,æˆ‘å°±å»é¢†äº†çœ‹.

è¿™é‡Œ,æˆ‘å°±å˜æˆäº†**è®¢é˜…è€…**,æŠ¥äº­å°±æ˜¯**å‘å¸ƒè€…**,å½“æŠ¥çº¸é€åˆ°çš„æ—¶å€™(çŠ¶æ€å‘ç”Ÿæ”¹å˜,é€šçŸ¥è®¢é˜…è€…),æˆ‘å°±å»é¢†äº†çœ‹(åšä¸€äº›æ“ä½œ).

æˆ‘ä»¬çœ‹åˆ°, è®¢é˜…è€…æ¨¡å¼æœ‰ä¸¤ä¸ªå®ä½“, ä¸€ä¸ªå‘å¸ƒè€…, ä¸€ä¸ªæ˜¯è®¢é˜…è€….



å‘å¸ƒè€…æœ‰ä¸‰ä¸ªåŠŸèƒ½: è®¢é˜…, å‘å¸ƒ, é€€è®¢.



### ç®€å•åˆ°çˆ†ç‚¸çš„ç‰ˆæœ¬

ğŸ¤“è®©æˆ‘ä»¬åŠ¨æ‰‹æ¥å†™ä¸€ä¸ªè¯•è¯•.



è®¢é˜…åŠŸèƒ½: 

```javascript
let Publisher = {};
let eventQueue = {}; // å­˜äº‹ä»¶, ä¸€ä¸ªäº‹ä»¶åå¯¹åº”ä¸€ä¸ªå‡½æ•°

publisher.subscribe = function(event, listener) {
     eventQueue[event] = listener;
}
```

å‘å¸ƒåŠŸèƒ½: 

```JavaScript
publisher.publish = function(event) {
    let listener = eventQueue[event];
    listener && listener();             // å¦‚æœå­˜åœ¨, åˆ™è°ƒç”¨ç›‘å¬å™¨
}
```

é€€è®¢åŠŸèƒ½: 

```JavaScript
// å°†ç›‘å¬å™¨ä» eventQueue åˆ é™¤(è®¾ä¸º null)
publisher.off = function(event, listener) {   
    if(!eventQueue[event]) return;
    eventQueue[event] = null;
}
```

è¿™æ ·, æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç®€é™‹çš„è§‚å¯Ÿè€…æ¨¡å¼äº†

```JavaScript
publisher.subscribe("eventA", function() {
	console.log("eventA, publish!");
});
publisher.publish("eventA");     // eventA, publish!"
```

ä½†æ˜¯è¿™æ ·ä¹Ÿå¤ªç®€é™‹äº†, eventQueue éƒ½æ˜¯æš´éœ²åœ¨å¤–çš„, è€Œä¸”ä¸€ä¸ªäº‹ä»¶åªèƒ½è®¢é˜…ä¸€ä¸ªæ“ä½œè€Œä¸”æ²¡åŠæ³•ä¼ å‚.



#### å®Œå–„ä¸€ä¸‹

è®©æˆ‘ä»¬æ”¹è¿›ä¸€ä¸‹, åŠ å…¥ç»™äº‹ä»¶ç›‘å¬å™¨ä¼ å‚çš„åŠŸèƒ½, ä¸€ä¸ªäº‹ä»¶æ³¨å†Œå¤šä¸ªç›‘å¬å™¨

```javascript
let publisher = (function(){
    let eventQueue = {};  // å°†äº‹ä»¶å­˜åœ¨é—­åŒ…ä¸­, æ¯ä¸€ä¸ªäº‹ä»¶,ä¿å­˜ä¸€ä¸ªç›‘å¬å™¨æ•°ç»„
    
  	return {
      
        subscribe(event, listener) {
            if(eventQueue[event]) {
                eventQueue[event].push(listener);
            } else {
                eventQueue[event] = [];
                eventQueue[event].push(listener);
            }
          
          	// ä¸‹é¢è¿™ä¸ªå†™æ³•ç®€å•äº›, ä½†æ˜¯ä¸å¥½è¯»..
          	// (eventQueue[event] = eventQueue[event] || []).push(listener);
        },
      
	
        publish(event, ...args) {
            let listeners = eventQueue[event];
            if(!listeners) return;
            listeners.forEach((listener) => {
                listener(...args);
            })
        },
      
      
        off(event, listener) {
            let listeners = eventQueue[event];
            eventQueue[event] = listeners.filter((l) => {
                return l !== listener;
            });
        }
    }
}());

// æµ‹è¯•
function listener(a, b) {
    console.log(`a: ${a}`);
    console.log(`b: ${b}`);
}

publisher.subscribe("eventA", listener);
publisher.publish("eventA", "hello", "world"); //a: hello
										   //b: world
publisher.off("eventA", listener);
publisher.publish("eventA", "hello", "world"); // æ²¡è¾“å‡ºä¸œè¥¿çš„
```

è¿™æ ·, æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„è§‚å¯Ÿè€…æ¨¡å¼äº†. (ä½†æ˜¯è¿™æ ·ä¸€ç‚¹ä¹Ÿä¸ OOå•Š)

è®©æˆ‘æŠŠå®ƒå°è£…æˆä¸€ä¸ªç±», è¿™æ ·å®ƒå°± OOäº†.



```javascript
function Publisher() {
    this.event = {};
}
```



```javascript
Publisher.prototype.subscribe = function(event, listener) {
    if(this.eventQueue[event]) {
        this.eventQueue[event].push(listener);
    } else {
        this.eventQueue[event] = [];
        this.eventQueue[event].push(listener);
    }
}
```



```javascript
Publisher.prototype.publish = function(event, ...args) {
    let listeners = this.eventQueue[event];
    if(!listeners) return;
    listeners.forEach((listener) => {
        listener(...args);
    });
}
```



```javascript
Publisher.prototype.off = function(event, listener) {
    let listeners = this.eventQueue[event];
    this.eventQueue[event] = listeners.filter((l) => {
        return l !== listener;
    });
}
```



ç”¨èµ·æ¥è¯•è¯•: 

```JavaScript
let publisher = new Publisher();

publisher.subscribe("eventA", listener);
publisher.publish("eventA", "hello", "world"); // a: hello b: world
publisher.off("eventA", listener);
publisher.publish("eventA", "hello", "world"); // æ²¡è¾“å‡º

```

OK è¾£, åŠŸèƒ½ä¹Ÿè¿˜ç®—å®Œå–„

ç„¶è€Œ, å¦‚æœæ˜¯è€å¸æœº, ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥, å…¶å®è¿™ä¸ªä¸œè¥¿æ˜¯å’Œ node çš„ [EventEmitter](https://nodejs.org/api/events.html#events_class_eventemitter) å¾ˆåƒçš„: æ·»åŠ äº‹ä»¶ç›‘å¬, å‘å¸ƒäº‹ä»¶.



æˆ‘ä»¬åªéœ€è¦æ”¹è¯¥åå­—, å°±å¯ä»¥ä¼ªè£…æˆ node çš„ EventEmitter äº†

**FBI warning**: ä¸‹é¢ä»£ç å…¶å®å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„, åªæ˜¯æ”¹äº†å±æ€§æ–¹æ³•åè€Œå·²;

```JavaScript
function EventEmitter() {
    this._eventQueue = {};
}
EventEmitter.prototype.on = function(event, listener) {
    if(this._eventQueue[event]) {
        this._eventQueue[event].push(listener);
    } else {
        this._eventQueue[event] = [];
        this.eventQuone[event].push(listener);
    }
}

EventEmitter.prototype.emit = function(event, ...args) {
    let listeners = this._eventQueue[event];
    if(!listeners) return;
    listeners.forEach((listener) => {
        listener(...args);
    });
}

EventEmitter.prototype.off = function(event, listener) {
    let listeners = this._eventQueue[event];
    this._eventQueue[event] = listeners.filter((l) => {
        return l !== listener;
    });
}

let emitter = new Emitter();
emitter.on("request", function() {
	console.log("on request");
});
emitter.emit("request");
// do some thing
```



## äº‹ä»¶

#### ç„¶è€Œ, æˆ‘ä»¬å†™é‚£ä¹ˆå¤šæœ‰ä»€ä¹ˆç”¨?

EventEmitter æ˜¯ node çš„æ ¸å¿ƒæ¨¡å—, å›å¿†ä¸€ä¸‹,

å†™ nodejs ä»£ç çš„æ—¶å€™, æ˜¯ä¸æ˜¯ç»å¸¸å†™ä¸€äº›äº‹ä»¶ç›‘å¬?

ä¸¾ä¸ªä¾‹å­: 

```JavaScript
http.createServer(function(request, response) {
	request.on("data", function() {
		// do something
    });
})
```

å…¶å®, çœ‹ä¼¼ç®€å•çš„ä»£ç , èƒŒåæ€»æ˜¯éšè—ç€åé¢æ— æ•°ä»£ç çš„è¾›å‹¤å·¥ä½œ

request æ˜¯ http.IncomingMessage ç±»çš„ä¸€ä¸ªå®ä¾‹, (æ¯ä¸€ä¸ªè¯·æ±‚, éƒ½ä¼š new ä¸€ä¸ªhttp.IncomingMessage ç„¶åä¼ å…¥åˆ°ä¸Šé¢çš„åŒ¿åå‡½æ•°é‡Œé¢å»);

 http.IncomingMessage ç±»ç›´æ¥ç»§æ‰¿äº† EventEmitter ç±»



ä»¥ä¸‹è¯·å‡è£…æ˜¯ä¼ªä»£ç , ç®€å•æ¨¡æ‹Ÿäº†ä¸€ä¸‹

```JavaScript
let http = require('http');
let events = require('event');


/***********************
	å‡è£…è¿™é‡Œæ˜¯httpæ¨¡å—é‡Œçš„ä»£ç 
***********************/
http.IncomingMessage = function() {
	events.EventEmitter.call(this);
	// something else
}
utils.inherits(http.IncomingMessage, events.EventEmitter);


/******************
createSever 
*******************/

http.createServer = function(listener) {
  // balabala
	let request = new http.IncomingMessage();
  	listenter(request, response);   // responseå°±ä¸å†™äº†
  // do something
}


/*****************
	è¿™é‡Œ,ä½  create äº†ä¸€ä¸ª http server
    request å…¶å®æ˜¯ IncomingMessage çš„å®ä¾‹

****************/
http.createServer(function(request, response) {
	request.on("data", function(data) {
		// do something
    });
});


/***********
	ä½ å†™å®Œä¸Šé¢é‚£é‡Œä»¥å, eventEmitter é»˜é»˜çš„æŠŠä½ ä¸Šé¢çš„åŒ¿åå‡½æ•°æ”¾åˆ°äº‹ä»¶é˜Ÿåˆ—é‡Œé¢äº†
**************/


// çœ‹è¿™é‡Œ

/****
	ç„¶åç”¨æˆ·å‘äº†ä¸€äº›æ•°æ®, æ¯”å¦‚è¯·æ±‚
	
	ç„¶åè¿è¡Œ è¿™æ®µä»£ç :  request.emit('data', data);
	ç„¶åä½ æ·»åŠ çš„äº‹ä»¶ç›‘å¬å‡½æ•°å°±è¿è¡Œäº†
****/

//over
```

ä»¥ä¸Šå¤§è‡´å°±æ˜¯request äº‹ä»¶è®¢é˜…å’Œå‘å¸ƒçš„è¿‡ç¨‹äº†.

**è§‰å¾—å¤ªéº»çƒ¦ä¸æƒ³çœ‹?**

æˆ‘ä»¬æ¥çœ‹çœ‹ç®€å•çš„ç”¨æ³•: 

å¦‚æœä½ éœ€è¦åœ¨ä»£ç ä¸­ä½¿ç”¨äº‹ä»¶

ä½ åªéœ€è¦: 

```JavaScript
function YourClass() {
	EventEmitter.call(this);
}
utils.inherts(YourClass, EventEmitter);
```

è¿™æ ·, YourClass ç±»çš„å®ä¾‹, å°±å¯ä»¥ç”¨ on, emitter å»æ·»åŠ å’Œå‘å¸ƒäº‹ä»¶äº†



**ç„¶è€Œ, æˆ‘ä¸ç”¨ç»™è‡ªå·±çš„ç±»æ·»åŠ äº‹ä»¶ä¹Ÿèƒ½å†™å‡ºåŠŸèƒ½æ¥å•Š**

è¿™ä¸ªäº‹ä»¶ç±», å…¶å®å¯ä»¥è®©ä½ çš„ä»£ç å‡å°‘åµŒå¥—ä¸¾ä¸ªä¾‹å­, ä»¥ä¸‹ä»£ç ä¸èƒ½è¿è¡Œ

```javascript
app.get(function(req, res) {
	let xxx = req.params['xxx'];
	mysql.query('select * from table where xxx=$', [xxx], function(result) {
    	mysql.query('select * from table where xxx=${result}', function() {
			// do something
		});
	});
})
```



```JavaScript
emitter.on("queryxxx", function(result) {
  mysql.query('select * from table where xxx=${result}', function() {
    // do something
  });
});

app.get(function(req, res) {
  let xxx = req.params['xxx'];
  mysql.query('select * from table where xxx=$', [xxx], function(result) {
    emitter.emit("queryxxx", result);
  })
})
```

å¯ä»¥çœ‹åˆ°äº‹ä»¶å¯ä»¥å‡å°‘ä»£ç åµŒå¥—è¿‡æ·±çš„é—®é¢˜

(  å½“ç„¶å…¶å®ç”¨ promise, yeildä¹Ÿå¯ä»¥è§£å†³, è€Œä¸”ä¼˜é›…çš„å¤š.

ç„¶è€Œå…¶å®å®ƒçš„ä½œç”¨å½“ç„¶ä¸æ˜¯è¿™ä¹ˆç®€å•çš„.

è§‚å¯Ÿè€…æ¨¡å¼æ›´å¤šçš„ç”¨äºå‰ç«¯çš„ MV*æ¡†æ¶

å¤§æ¦‚æ˜¯è¿™æ ·:    æ•°æ®æ”¹å˜->å‘å¸ƒæ•°æ®æ”¹å˜çš„äº‹ä»¶-> æ¸²æŸ“é¡µé¢

æ¨¡æ‹Ÿä¸€ä¸‹: 

```javascript
data.on("change", function() {
	// æ¸²æŸ“é¡µé¢, å’Œåšä¸€äº›å…¶ä»–çš„äº‹æƒ…
});

// å‘æ¡†æ¶ä½¿ç”¨è€…æä¾›æ”¹å˜ data çš„æ¥å£ 
data.setData = function(data) {
	// do something
  	data.emit("change", data);
}
```

åœ¨ js ä¸­,å¦‚æœåªæ˜¯é’ˆå¯¹æ•°æ®çš„æ”¹å˜è§¦å‘äº‹ä»¶çš„è¯,å…¶å® getter, setter æ˜¯æ›´å¥½çš„é€‰æ‹©, å¾ˆå¤šæ¡†æ¶å°±æ˜¯ä½¿ç”¨äº† getter, setter å®ç°çš„









